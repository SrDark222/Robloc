<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Roblox Avatar 3D Dançando - DK Edition A+</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap');
  * {
    margin:0; padding:0; box-sizing: border-box; font-family: 'Orbitron', sans-serif;
  }
  body, html {
    height: 100%; background: linear-gradient(135deg,#050a20 0%,#0a0f3c 100%);
    display: flex; flex-direction: column; align-items: center; justify-content: center; color: #00aaff;
    user-select:none;
  }
  h1 {
    margin: 20px 0; font-weight: 700; text-shadow: 0 0 10px #00aaffaa;
  }
  #inputNick {
    width: 280px; padding: 12px 15px; border-radius: 12px; border: none;
    font-size: 18px; background: #0a1f3cbb; color: #00aaff;
    box-shadow: inset 0 0 10px #00aaff55;
    outline:none;
    transition: box-shadow 0.3s ease;
  }
  #inputNick:focus {
    box-shadow: inset 0 0 20px #00ccffaa;
  }
  #btnLoad {
    margin-left: 12px; padding: 12px 20px; border-radius: 12px;
    background: #00aaff; border: none; color: #001522;
    font-weight: 700; font-size: 18px;
    cursor: pointer; transition: background 0.3s ease;
  }
  #btnLoad:hover {
    background: #0090ff;
  }
  #canvas-container {
    margin-top: 30px;
    width: 450px; height: 600px;
    border-radius: 20px;
    background: rgba(0, 170, 255, 0.1);
    box-shadow: 0 0 40px #00aaffcc;
    backdrop-filter: blur(12px);
    overflow: hidden;
    position: relative;
  }
  #status {
    position: absolute; top: 10px; left: 10px;
    color: #00ccffdd; font-weight: 600;
    text-shadow: 0 0 8px #00aaffbb;
    z-index: 10;
  }
  #animationControls {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  .animBtn {
    background: #003366;
    color: #00aaff;
    border-radius: 10px;
    padding: 10px 15px;
    cursor: pointer;
    user-select:none;
    font-weight: 600;
    transition: background 0.3s ease;
  }
  .animBtn:hover {
    background: #0055aa;
  }
</style>
</head>
<body>

<h1>Roblox Avatar 3D Dançando - DK Edition A+</h1>
<div>
  <input id="inputNick" type="text" placeholder="Cola o nick do player aqui" />
  <button id="btnLoad">Buscar Avatar</button>
</div>
<div id="canvas-container">
  <div id="status">Aguardando nick...</div>
</div>
<div id="animationControls" style="display:none;">
  <div class="animBtn" data-anim="idle">Idle</div>
  <div class="animBtn" data-anim="dance">Dançar</div>
  <div class="animBtn" data-anim="run">Correr</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>

<script>
  const container = document.getElementById('canvas-container')
  const status = document.getElementById('status')
  const animControls = document.getElementById('animationControls')
  const animButtons = [...document.querySelectorAll('.animBtn')]

  let scene, camera, renderer, mixer, clock, avatarModel, currentAction

  clock = new THREE.Clock()

  function initScene() {
    scene = new THREE.Scene()
    scene.background = new THREE.Color(0x001122)
    camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000)
    camera.position.set(0, 1.7, 3.5)

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true })
    renderer.setSize(container.clientWidth, container.clientHeight)
    container.appendChild(renderer.domElement)

    const light = new THREE.DirectionalLight(0xffffff, 1)
    light.position.set(0, 10, 10)
    scene.add(light)

    const ambient = new THREE.AmbientLight(0x404040, 2)
    scene.add(ambient)

    // chão simples
    const floorGeo = new THREE.PlaneGeometry(10, 10)
    const floorMat = new THREE.MeshStandardMaterial({ color: 0x002244, roughness: 1 })
    const floor = new THREE.Mesh(floorGeo, floorMat)
    floor.rotation.x = -Math.PI / 2
    floor.position.y = 0
    scene.add(floor)
  }

  function animate() {
    requestAnimationFrame(animate)
    if(mixer) mixer.update(clock.getDelta())
    renderer.render(scene, camera)
  }

  // Pega userId com fallback em várias APIs
  async function getUserId(nick) {
    let apis = [
      `https://api.roblox.com/users/get-by-username?username=${nick}`,
      `https://users.roblox.com/v1/usernames/users`, // POST
      `https://api.roblox.plus/user/${nick}`,
      `https://api.roblox.plus/user/search?q=${nick}`,
    ]
    try {
      // Primeiro tenta API oficial GET
      let res = await fetch(apis[0])
      let data = await res.json()
      if(data && data.Id) return data.Id

      // Se falhar, tenta a API POST da users.roblox.com
      res = await fetch(apis[1], {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({usernames: [nick]})
      })
      data = await res.json()
      if(data && data.data && data.data.length > 0 && data.data[0].id) return data.data[0].id

      // Outras tentativas (se quiser expandir, manda)
    } catch(e) {
      console.warn("Erro ao buscar UserId", e)
    }
    return null
  }

  // Carrega o modelo 3D real do avatar via Roblox Avatar API
  async function loadAvatarModel(userId) {
    if(avatarModel){
      scene.remove(avatarModel)
      mixer = null
      avatarModel = null
    }

    status.textContent = "Carregando avatar 3D..."

    // O endpoint oficial para pegar assets 3D do avatar não é público pra baixar direto.
    // Mas tem alternativas, exemplo:
    // Usar esse endpoint não oficial (exemplo fake): https://avatar.roblox.com/v1/avatar/render?userId=USERID&format=glb
    // Como alternativa pra demo, vamos usar um modelo genérico com animação

    // === Código pra demo ===
    const loader = new THREE.GLTFLoader()
    const demoModels = {
      idle: "https://models.babylonjs.com/Dude/dude.gltf",
      dance: "https://models.babylonjs.com/Soldier/Soldier.gltf",
      run: "https://models.babylonjs.com/Warrior/Warrior.gltf"
    }

    let currentAnim = 'idle'

    await new Promise((resolve, reject) => {
      loader.load(demoModels[currentAnim], gltf => {
        avatarModel = gltf.scene
        avatarModel.scale.set(0.02, 0.02, 0.02)
        scene.add(avatarModel)

        mixer = new THREE.AnimationMixer(avatarModel)
        currentAction = mixer.clipAction(gltf.animations[0])
        currentAction.play()

        resolve()
      }, undefined, e => reject(e))
    })

    status.textContent = "Avatar carregado! (Demo com modelo genérico)"
    animControls.style.display = "flex"
  }

  // Trocar animação demo
  function changeAnimation(name){
    if(!mixer || !avatarModel) return
    if(currentAction) currentAction.stop()

    const loader = new THREE.GLTFLoader()
    let demoModels = {
      idle: "https://models.babylonjs.com/Dude/dude.gltf",
      dance: "https://models.babylonjs.com/Soldier/Soldier.gltf",
      run: "https://models.babylonjs.com/Warrior/Warrior.gltf"
    }

    loader.load(demoModels[name], gltf => {
      scene.remove(avatarModel)
      avatarModel = gltf.scene
      avatarModel.scale.set(0.02, 0.02, 0.02)
      scene.add(avatarModel)
      mixer = new THREE.AnimationMixer(avatarModel)
      currentAction = mixer.clipAction(gltf.animations[0])
      currentAction.play()
    })
  }

  document.getElementById("btnLoad").onclick = async () => {
    const nick = document.getElementById("inputNick").value.trim()
    if(!nick){
      alert("Cola o nick aí, irmão!")
      return
    }
    status.textContent = "Buscando userId..."
    const userId = await getUserId(nick)
    if(!userId){
      status.textContent = "Nick não encontrado, tenta outro aí"
      return
    }
    status.textContent = `UserId encontrado: ${userId}`
    await loadAvatarModel(userId)
  }

  animButtons.forEach(btn => {
    btn.onclick = () => changeAnimation(btn.dataset.anim)
  })

  initScene()
  animate()
</script>

</body>
</html>
